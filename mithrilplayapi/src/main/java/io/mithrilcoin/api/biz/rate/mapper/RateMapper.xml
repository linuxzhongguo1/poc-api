<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.mithrilcoin.api.biz.rate.mapper.RateMapper">
	<insert id="insertMemberrate" parameterType="io.mithril.vo.rate.Memberrate"
		useGeneratedKeys="true" keyProperty="idx">
		INSERT INTO MEMBERRATE
		(
		RATE_IDX
		,MEMBER_IDX
		,REGISTDATE
		)
		VALUES
		(
		#{rate_idx}
		,#{member_idx}
		,#{registdate}
		)
	</insert>
	<insert id="insertRatehistory" parameterType="io.mithril.vo.rate.Ratehistory"
		useGeneratedKeys="true" keyProperty="idx">
		INSERT INTO RATEHISTORY
		(
		MEMBER_IDX
		,AMOUNT
		,CURRENTAMOUNT
		,STATECODE
		,REGISTDATE
		)
		VALUES
		(
		#{member_idx}
		,#{amount}
		,#{currentamount}
		,#{statecode}
		,#{registdate}
		)
	</insert>
	<select id="selectRatelist" resultType="io.mithril.vo.rate.Rate">
		SELECT
		IDX
		,NAME
		,REWARD
		,RPREWARD
		,RATING
		,DEPOSITRATE
		,FEERATE
		,UPRATEIDX
		,DOWNRATEIDX
		,MINMTP
		,MINGAME
		,MINAVGPLAYTIME
		,MINPLAYTIME
		,WIDGETYN
		,AUTHYN
		,FOLLOWERYN
		,TYPECODE
		,REGISTDATE
		,MODIFYDATE
		,MODIFYID
		FROM RATE
	</select>
	<select id="selectRateByName" parameterType="String"
		resultType="io.mithril.vo.rate.Rate">
		SELECT
		NAME
		,REWARD
		,RPREWARD
		,RATING
		,DEPOSITRATE
		,FEERATE
		,UPRATEIDX
		,DOWNRATEIDX
		,FOLLOWERYN
		,TYPECODE
		,MINMTP
		,MINGAME
		,MINAVGPLAYTIME
		,MINPLAYTIME
		,REGISTDATE
		,MODIFYDATE
		,MODIFYID
		FROM RATE
		WHERE
		NAME = #{name}
	</select>
	<select id="selectMemberrateByMemberIdx" parameterType="Long"
		resultType="io.mithril.vo.rate.Memberrate">
		SELECT
		IDX
		,RATE_IDX
		,MEMBER_IDX
		,REGISTDATE
		FROM MEMBERRATE
		WHERE
		MEMBER_IDX = #{member_idx}
	</select>
	<select id="selectLastMemberrateByMemberIdx" parameterType="Long"
		resultType="io.mithril.vo.rate.Memberrate">
		SELECT
		IDX
		,RATE_IDX
		,MEMBER_IDX
		,REGISTDATE
		FROM MEMBERRATE
		WHERE
		MEMBER_IDX = #{member_idx}
		ORDER BY IDX DESC LIMIT 1
	</select>
	<select id="selectLastRatehistoryByMemberIdx" parameterType="Long"
		resultType="io.mithril.vo.rate.Ratehistory">
		SELECT
		IDX
		,MEMBER_IDX
		,AMOUNT
		,CURRENTAMOUNT
		,STATECODE
		,REGISTDATE
		FROM RATEHISTORY
		WHERE
		MEMBER_IDX = #{member_idx}
		ORDER BY IDX DESC LIMIT 1
	</select>
	<select id="selectRankgrade" parameterType="Long" resultType="Long">
		SELECT COUNT(1)
		FROM
		(
		SELECT
		MAX(IDX)
		FROM RATEHISTORY
		WHERE
		CURRENTAMOUNT <![CDATA[>]]>
		#{amount}
		GROUP BY MEMBER_IDX
		) RATE
	</select>
	<select id="selectMemberrate" parameterType="Long"
		resultType="io.mithril.vo.rate.Memberrate">
		SELECT
		IDX
		,RATE_IDX
		,MEMBER_IDX
		,REGISTDATE
		FROM MEMBERRATE
		WHERE
		MEMBER_IDX = #{member_idx}
		<if test="rate_idx gt 0">
			AND RATE_IDX = #{rate_idx}
		</if>
	</select>
	<select id="selectRankgradeByGroup" parameterType="Long"
		resultType="Integer">
		<![CDATA[
			SELECT COUNT(1)
			FROM MEMBERRATE MBR, RATEHISTORY RH
			WHERE 
				MBR.IDX IN (
				    SELECT MAX(MB.IDX)
				    FROM MEMBERRATE MB
				    WHERE MB.RATE_IDX = #{rate_idx}
				    GROUP BY MB.MEMBER_IDX
				)
				AND MBR.MEMBER_IDX = RH.MEMBER_IDX
				AND RH.IDX IN 
				(
					SELECT MAX(IDX) FROM RATEHISTORY
					WHERE CURRENTAMOUNT > #{ratepoint}
					GROUP BY MEMBER_IDX
				)
		]]>
	</select>
	<select id="selectRateproperty" resultType="io.mithril.vo.rate.Rateproperty">
		SELECT 
			IDX
			,RATETYPE
			,PRIORITY
			,NAME
			,VALUE
			,REGISTDATE
		FROM RATEPROPERTY
	</select>
	<select id="selectRatevariable" resultType="io.mithril.vo.rate.Ratevariable">
		SELECT
			IDX
			,RATETYPE
			,VALUE
			,NAME
			,CATEGORY
			,CHECKPOINT
			,REGISTDATE
		FROM RATEVARIABLE
	</select>
</mapper>